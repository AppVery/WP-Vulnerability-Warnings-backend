const getNewData = require('./request')
const defineNewItems = require('./diff')
const sendEmail = require('./email')
const { getSavedData, saveData } = require('./database')
const createAndSendNewCampaign = require('./newsletter')
const noticeToExternalService = require('./api')
require('dotenv').config()

module.exports = async function newScan() {
  try {
    const savedData = await getSavedData()
    const newData = await getNewData()
    const newItems = defineNewItems(savedData, newData)

    if (newItems['plugins'].length > 0 || newItems['themes'].length > 0) {
      sendEmail(newItems)
      if (process.env.WP_VULN_CAMPAIGN) {
        await createAndSendNewCampaign(newItems)
      }
      if (process.env.WP_VULN_EXTERNAL_API) {
        await noticeToExternalService(newItems)
      }
    }

    await saveData(newData)
  } catch (error) {
    console.log(error)
  }
}
