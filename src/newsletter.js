const MailerLite = require('mailerlite-api-v2-node').default
const makeReport = require("./report");
require("dotenv").config();

// https://developers.mailerlite.com/reference
// https://github.com/zygos/mailerlite-api-v2-node
const mailerLite = MailerLite(process.env.WP_VULN_MAILERLITE_API_KEY)

async function createCampaign() {
  const campaingData = {
    subject: 'WordPress Vulnerability Warnings',
    type: 'regular',
    groups: [process.env.WP_VULN_MAILERLITE_GROUPID],
  }
  return await mailerLite.createCampaign(campaingData)
}

async function setCampaignContent(id, newItems) {

  let html = makeReport(newItems);
  html += `<hr />
  <h6><strong>AppVery</strong> | WordPress Plugins &amp; Themes vulnerabilities newsletter<br />This message has been sent to <a href="mailto:{$email}"><strong>{$email}</strong></a> | <a href="{$unsubscribe}">Unsubscribe</a> | <a href="{$forward}">Forward this email to a friend</a></h6>
  `;
  const plain = "Your email client does not support HTML emails. Open newsletter here: {$url}. If you do not want to receive emails from us, click here: {$unsubscribe}"

  return await mailerLite.setCampaignContent(id, { html, plain })
}

async function sendCampaignNow() {
  await mailerLite.actOnCampaign(id, 'send', { type: 1 })
}

module.exports = function createAndSendNewCampaign(newItems) {
  const campaign = await createCampaign()
  await setCampaignContent(campaign.id, newItems)
  await sendCampaignNow(campaign.id)
}