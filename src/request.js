const request = require('request-promise')
const cheerio = require('cheerio')

module.exports = async function getNewData() {
  const baseURL = 'https://wpscan.com'
  const plugins = await getTableData(baseURL + '/plugins')
  const themes = await getTableData(baseURL + '/themes')

  return Promise.all([plugins, themes])
    .then((data) => ({
      plugins: data[0],
      themes: data[1],
    }))
    .catch((err) => console.log(err))
}

async function getTableData(url) {
  let data = []
  try {
    const $ = await requestDataFromUrl(url)
    $('div[class*="item_itemWrapper"]').each((i, item) => {
      const links = $(item).find('a')
      data.push({
        name: $(links[0]).text(),
        title: $(links[1]).text(),
        link: `https://wpscan.com${$(links[1]).attr('href')}`,
      })
    })
    return data
  } catch (error) {
    console.log(error)
  }
}

async function requestDataFromUrl(url) {
  return await request({
    uri: url,
    transform: (body) => cheerio.load(body),
  })
}
