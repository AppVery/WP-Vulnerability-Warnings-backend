const mongoose = require('mongoose')

let db

async function createConnection() {
  try {
    db = await mongoose.connect(process.env.WP_VULN_MONGODB_URI, {
      useNewUrlParser: true,
      useUnifiedTopology: true,
    })
    console.log('connected to MongoDB')
  } catch (error) {
    console.log('error connecting to MongoDB:', error.message)
  }
}

async function closeConnection() {
  try {
    await db.disconnect()
    console.log('disconnected to MongoDB')
  } catch (error) {
    console.log('error disconnecting to MongoDB:', error.message)
  }
}

const dataSchema = new mongoose.Schema({
  plugins: Array,
  themes: Array,
})

const Data = mongoose.model('Data', dataSchema)

async function getSavedData() {
  let data = await Data.find({})
  if (data.length === 0) data = [{ plugins: [], themes: [] }]
  return data[0]
}

async function saveData(newData) {
  await Data.deleteMany({})
  const data = new Data({
    plugins: newData['plugins'],
    themes: newData['themes'],
  })
  return await data.save()
}

module.exports = {
  createConnection,
  closeConnection,
  getSavedData,
  saveData,
}
